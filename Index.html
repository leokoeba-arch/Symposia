<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Symposia</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <header class="mb-6 text-center">
    <h1 class="text-4xl font-bold text-indigo-700">Symposia</h1>
    <p class="text-gray-600">Turn your clinical notes into publishable drafts</p>
  </header>

  <main class="w-full max-w-2xl bg-white shadow-lg rounded-2xl p-6">
    <label class="block mb-2 font-medium">Enter or Dictate Your Notes</label>
    <div class="flex gap-2 mb-4">
      <textarea id="inputText" class="w-full border rounded-lg p-2" rows="6" placeholder="Paste notes here or use the mic..."></textarea>
      <button id="micBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg" title="Start/Stop dictation">ðŸŽ¤</button>
    </div>

    <label class="block mb-2 font-medium">Upload Images (optional)</label>
    <input id="imgInput" type="file" class="mb-4 w-full" accept=".jpg,.jpeg,.png" multiple />

    <p class="text-xs text-gray-500 mb-2">DOCX/PDF upload coming next after deploy.</p>

    <label class="block mb-2 font-medium">Choose Format</label>
    <select id="format" class="w-full border rounded-lg p-2 mb-4">
      <option>Abstract</option>
      <option>Case Study</option>
      <option>Presentation (PPT)</option>
    </select>

    <button id="generateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg w-full">Generate Draft</button>
    <div id="status" class="text-sm text-gray-500 mt-3 hidden">Generating draftâ€¦</div>

    <div id="output" class="mt-6 p-4 border rounded-lg bg-gray-50 hidden whitespace-pre-line"></div>

    <div id="downloadSection" class="mt-4 hidden flex gap-2">
      <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Download Word</button>
      <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Download PPT</button>
      <button class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg">Download PDF</button>
    </div>
  </main>

  <script>
    // Voice-to-text
    const micBtn = document.getElementById('micBtn');
    const inputText = document.getElementById('inputText');
    let recognition, listening = false;

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      recognition.onresult = (event) => {
        let transcript = inputText.value;
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        inputText.value = transcript;
      };
      micBtn.addEventListener('click', () => {
        if (!listening) {
          recognition.start();
          micBtn.textContent = 'ðŸ›‘';
          micBtn.classList.replace('bg-red-500', 'bg-green-500');
          listening = true;
        } else {
          recognition.stop();
          micBtn.textContent = 'ðŸŽ¤';
          micBtn.classList.replace('bg-green-500', 'bg-red-500');
          listening = false;
        }
      });
    } else {
      micBtn.disabled = true;
      micBtn.title = "Speech recognition not supported in this browser";
    }

    // Read selected images as data URLs
    async function readImagesAsDataURLs(files) {
      const readers = [...files].map(file => new Promise((resolve, reject) => {
        const ext = file.name.toLowerCase();
        if (!ext.endsWith('.jpg') && !ext.endsWith('.jpeg') && !ext.endsWith('.png')) return resolve(null);
        const fr = new FileReader();
        fr.onload = () => resolve({ name: file.name, dataUrl: fr.result });
        fr.onerror = reject;
        fr.readAsDataURL(file);
      }));
      const results = await Promise.all(readers);
      return results.filter(Boolean);
    }

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const format = document.getElementById('format').value;
      const notes = inputText.value.trim();
      const imgs = document.getElementById('imgInput').files;

      const status = document.getElementById('status');
      status.classList.remove('hidden');
      status.textContent = 'Generating draftâ€¦';

      try {
        const images = await readImagesAsDataURLs(imgs);
        const resp = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ format, notes, images })
        });
        const data = await resp.json();
        document.getElementById('output').textContent = data.draft || 'Error generating draft.';
        document.getElementById('output').classList.remove('hidden');
        document.getElementById('downloadSection').classList.remove('hidden');
        status.classList.add('hidden');
      } catch (e) {
        status.textContent = 'Failed to generate draft.';
      }
    });
  </script>
</body>
</html>
