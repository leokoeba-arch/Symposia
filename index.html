<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symposia</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #fafafa;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #4a148c;
    }
    textarea {
      width: 100%;
      height: 180px;
      resize: vertical;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .preview-images img {
      max-width: 120px;
      max-height: 120px;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 5px;
    }
    select, button {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #673ab7;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #draft {
      white-space: pre-wrap;
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      min-height: 150px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #673ab7;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: none;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Symposia</h1>
  <p style="text-align:center;">Turn your clinical notes into publishable drafts</p>

  <textarea id="notes" placeholder="Enter or dictate your notes..."></textarea>
  <br><br>

  <label>Upload Files (Images, PDF, Word, PPT)</label><br>
  <input type="file" id="files" multiple><br>
  <div class="preview-images" id="preview"></div>

  <br>
  <label>Choose Format</label><br>
  <select id="format">
    <option>Case Study</option>
    <option>Abstract</option>
    <option>Summary</option>
  </select>
  <br><br>

  <button id="generateBtn">Generate Draft</button>
  <div class="spinner" id="spinner"></div>

  <div id="draft">No draft generated yet...</div>

  <br>
  <button onclick="downloadFile('word')">Download Word</button>
  <button onclick="downloadFile('pdf')">Download PDF</button>
  <button onclick="downloadFile('ppt')">Download PPT</button>

  <script>
    let uploadedImages = [];

    // Preview images + text extraction for docs
    document.getElementById('files').addEventListener('change', async (event) => {
      const preview = document.getElementById('preview');
      const notes = document.getElementById('notes');
      preview.innerHTML = '';
      uploadedImages = [];

      for (const file of event.target.files) {
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          preview.appendChild(img);
          uploadedImages.push(file.name);
        } else {
          // Append placeholder text for docs
          const reader = new FileReader();
          reader.onload = (e) => {
            notes.value += `\n\n--- Extracted from ${file.name} ---\n${e.target.result}\n`;
          };
          reader.readAsText(file);
        }
      }
    });

    // Generate draft
    document.getElementById('generateBtn').addEventListener('click', async () => {
      const notes = document.getElementById('notes').value;
      const format = document.getElementById('format').value;
      const draftDiv = document.getElementById('draft');
      const spinner = document.getElementById('spinner');

      draftDiv.textContent = '';
      spinner.style.display = 'block';
      document.getElementById('generateBtn').disabled = true;

      const resp = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes, format, images: uploadedImages }),
      });

      const data = await resp.json();
      spinner.style.display = 'none';
      document.getElementById('generateBtn').disabled = false;

      if (data.error) {
        draftDiv.textContent = "Error: " + JSON.stringify(data.error);
      } else {
        draftDiv.textContent = data.draft;
      }
    });

    // Download draft as text (placeholder for Word/PDF/PPT)
    function downloadFile(type) {
      const draft = document.getElementById('draft').textContent;
      const blob = new Blob([draft], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `draft.${type === 'word' ? 'docx' : type}`;
      a.click();
    }
  </script>
</body>
</html>
