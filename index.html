<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Symposia</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:#f6f8fa;color:#1e293b}
    .top-banner{position:fixed;top:0;left:0;right:0;height:52px;background:#1e293b;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:1000}
    .login-btn{background:#2563eb;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer;visibility:hidden}
    #drName{margin-right:12px;display:none;cursor:pointer}
    .container{max-width:860px;margin:80px auto 40px;padding:24px;background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.05)}
    textarea{width:100%;min-height:160px;padding:12px;border:1px solid #cbd5e1;border-radius:8px;font:inherit}
    #generateBtn,#downloadBtn{margin-top:14px;width:100%;padding:12px;border:0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
    #generateBtn{background:#2563eb} #downloadBtn{background:#0ea5e9;display:none}
    #downloadCounter{font-weight:700}
    .user-menu{position:fixed;top:56px;right:16px;width:320px;max-width:92vw;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.15);display:none;flex-direction:column;z-index:999}
    .user-menu.open{display:flex}
    .user-menu-header{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid #e5e7eb}
    .avatar{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:#2563eb;color:#fff;font-weight:800}
    .plan-badge{margin-left:auto;font-size:.8rem;font-weight:700;border-radius:6px;padding:2px 6px;background:#f1f5f9;color:#475569}
    .menu-item{padding:8px 14px;text-align:left;background:none;border:0;width:100%;cursor:pointer}
    .menu-item.logout{color:#dc2626;font-weight:700}
    .side-menu-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:998}
    .side-menu-backdrop.open{display:block}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);z-index:2000;overflow:auto}
    .modal.open{display:block}
    .modal__panel{max-width:420px;margin:10vh auto;background:#fff;border-radius:12px;padding:24px;position:relative}
    .modal__close{position:absolute;top:10px;right:12px;border:0;background:transparent;font-size:22px;color:#64748b;cursor:pointer}
    .btn{width:100%;border:0;border-radius:10px;padding:12px;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
  </style>
</head>

<body>
  <div class="top-banner">
    <div class="logo" style="font-weight:800">Symposia</div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="drName">Dr.</div>
      <button class="login-btn" onclick="toggleAuthModal(true)">Log in / Register</button>
    </div>
  </div>

  <!-- ===== Side Menu ===== -->
  <div id="sideMenu" class="user-menu" aria-hidden="true">
    <div class="user-menu-header">
      <div class="avatar" id="sideMenuAvatar">D</div>
      <div class="user-info">
        <div id="sideMenuName">Dr. —</div>
        <div id="sideMenuEmail" class="muted"></div>
      </div>
      <span id="planBadge" class="plan-badge">Free</span>
    </div>
    <button class="menu-item" id="remainingDownloadsBtn" onclick="openUpgradeModal()">Remaining Downloads <span id="downloadCounter">0 / 8</span></button>
    <button class="menu-item logout" onclick="logoutUser()">Log out</button>
  </div>
  <div id="sideMenuBackdrop" class="side-menu-backdrop" onclick="toggleSideMenu(false)"></div>

  <!-- ===== Upgrade Modal ===== -->
  <div id="upgradeModal" class="modal" aria-hidden="true">
    <div class="modal__panel">
      <button class="modal__close" onclick="closeUpgradeModal()">×</button>
      <h2 class="modal__title">Upgrade your plan</h2>
      <p class="modal__subtitle">You’ve reached the maximum of 8 free downloads. Upgrade to continue using Symposia.</p>
      <button class="btn btn-primary" onclick="alert('Redirect to billing portal')">See Plans</button>
    </div>
  </div>

  <!-- ===== Main Container ===== -->
  <div class="container">
    <h1>Generate Draft</h1>
    <label>Notes</label>
    <textarea id="notesInput"></textarea>
    <button id="generateBtn">Generate Draft</button>
    <div id="output"></div>
    <button id="downloadBtn">Download Draft</button>
  </div>

  <!-- ===== Auth Modal Placeholder ===== -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal__panel">
      <button class="modal__close" onclick="toggleAuthModal(false)">×</button>
      <h2>Login / Register</h2>
      <input id="authEmail" placeholder="Email" style="width:100%;margin-bottom:6px"/>
      <input id="authPassword" type="password" placeholder="Password" style="width:100%;margin-bottom:6px"/>
      <button class="btn btn-primary" onclick="handlePrimaryAuth()">Continue</button>
      <button class="btn" onclick="continueWithGoogle()">Continue with Google</button>
    </div>
  </div>

  <!-- ===== Scripts ===== -->
  <script type="module">
    // ================= Firebase Setup =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, GoogleAuthProvider, onAuthStateChanged, updateProfile,
      sendPasswordResetEmail, signOut, getAdditionalUserInfo
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcjqnPesz2gb_tChRePmQs_Z7g_TiknUE",
      authDomain: "symposia-6411a.firebaseapp.com",
      projectId: "symposia-6411a",
      storageBucket: "symposia-6411a.firebasestorage.app",
      messagingSenderId: "764049033413",
      appId: "1:764049033413:web:a14022bac19894322dc8ac"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // ================= Firestore Helpers =================
    async function fetchDownloadCount(email) {
      if (!email) return 0;
      try {
        const ref = doc(db, "userDownloads", email);
        const snap = await getDoc(ref);
        return snap.exists() ? snap.data().count || 0 : 0;
      } catch (e) {
        console.error(e);
        return 0;
      }
    }
    async function saveDownloadCount(email, count) {
      if (!email) return;
      try {
        const ref = doc(db, "userDownloads", email);
        await setDoc(ref, { count }, { merge: true });
      } catch (e) {
        console.error(e);
      }
    }

    // ================= UI Helpers =================
    function toggleAuthModal(show){document.getElementById("authModal").classList.toggle("open",show);}
    function toggleSideMenu(show){
      const menu=document.getElementById("sideMenu");
      const back=document.getElementById("sideMenuBackdrop");
      if(show){menu.classList.add("open");back.classList.add("open");}
      else{menu.classList.remove("open");back.classList.remove("open");}
    }
    function openUpgradeModal(){
      const m=document.getElementById("upgradeModal");
      if(m){m.classList.add("open");m.setAttribute("aria-hidden","false");}
    }
    function closeUpgradeModal(){
      const m=document.getElementById("upgradeModal");
      if(m){m.classList.remove("open");m.setAttribute("aria-hidden","true");}
    }

    function updateUserUI(user){
      const dr=document.getElementById("drName");
      const btn=document.querySelector(".login-btn");
      const sideName=document.getElementById("sideMenuName");
      const sideEmail=document.getElementById("sideMenuEmail");
      const av=document.getElementById("sideMenuAvatar");
      if(!user){dr.style.display="none";btn.style.visibility="visible";return;}
      const nameParts=(user.displayName||user.email.split("@")[0]).split(" ");
      const surname=nameParts[nameParts.length-1];
      dr.textContent=`Dr. ${surname}`;
      dr.style.display="inline-block";btn.style.visibility="hidden";
      sideName.textContent=`Dr. ${surname}`;
      sideEmail.textContent=user.email;
      av.textContent=surname.charAt(0).toUpperCase();
    }

    // ================= Auth Logic =================
    async function handlePrimaryAuth(){
      const email=document.getElementById("authEmail").value.trim();
      const pass=document.getElementById("authPassword").value.trim();
      if(!email||!pass) return alert("Enter email and password");
      try{
        const {user}=await signInWithEmailAndPassword(auth,email,pass);
        localStorage.setItem("userEmail",user.email);
        toggleAuthModal(false);
        updateUserUI(user);
      }catch(e){
        try{
          const {user}=await createUserWithEmailAndPassword(auth,email,pass);
          await updateProfile(user,{displayName:email.split("@")[0]});
          localStorage.setItem("userEmail",user.email);
          toggleAuthModal(false);
          updateUserUI(user);
        }catch(err){alert(err.message);}
      }
    }
    function continueWithGoogle(){
      signInWithPopup(auth,googleProvider)
      .then(res=>{
        const u=res.user;
        localStorage.setItem("userEmail",u.email);
        updateUserUI(u);
        toggleAuthModal(false);
      }).catch(e=>alert(e.message));
    }
    function logoutUser(){
      signOut(auth).then(()=>{localStorage.removeItem("userEmail");updateUserUI(null);toggleSideMenu(false);})
      .catch(e=>alert(e.message));
    }

    // ================= Download Logic =================
    async function updateDownloadCounterUI(count){
      const c=document.getElementById("downloadCounter");
      if(c) c.textContent=`${count} / 8`;
    }

    async function handleDownload(){
      const content=document.getElementById("output").textContent||"";
      if(!content.trim()) return alert("No draft to download.");
      const user=auth.currentUser;
      if(!user) return alert("Please log in to download drafts.");
      let count=await fetchDownloadCount(user.email);

      // Hard limit check
      if(count>=8){openUpgradeModal();return;}

      // proceed with download
      const blob=new Blob(["\ufeff",content],{type:"application/msword"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download="symposia_draft.docx";
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(url);

      count+=1;
      await saveDownloadCount(user.email,count);
      updateDownloadCounterUI(count);
      if(count>=9) openUpgradeModal();
    }

    function bindDownloadButton(){
      const btn=document.getElementById("downloadBtn");
      if(!btn||btn.dataset.bound==="true") return;
      btn.dataset.bound="true";
      btn.addEventListener("click",handleDownload);
    }

    // observer ensures re-bind if DOM regenerates
    const observer=new MutationObserver(()=>bindDownloadButton());
    observer.observe(document.body,{childList:true,subtree:true});
    bindDownloadButton();

    // ================= Auth State =================
    onAuthStateChanged(auth,async(user)=>{
      updateUserUI(user);
      const loginBtn=document.querySelector(".login-btn");
      const drName=document.getElementById("drName");
      if(user){
        if(loginBtn) loginBtn.style.visibility="hidden";
        if(drName) drName.style.display="inline-block";
        const count=await fetchDownloadCount(user.email);
        updateDownloadCounterUI(count);
      }else{
        if(loginBtn) loginBtn.style.visibility="visible";
        if(drName) drName.style.display="none";
        updateDownloadCounterUI(0);
      }
    });

    // ================= Placeholder Generate =================
    document.getElementById("generateBtn").addEventListener("click",()=>{
      const notes=document.getElementById("notesInput").value.trim();
      const out=document.getElementById("output");
      if(!notes){out.textContent="";alert("Enter some notes.");return;}
      out.textContent=`Generated draft based on:\n\n${notes}`;
      document.getElementById("downloadBtn").style.display="block";
    });
  </script>
</body>
</html>
