<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Symposia</title>
    <link rel="stylesheet" href="../Symposia/symposia-web-app/src/styles.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Merriweather&display=swap" rel="stylesheet">
  </head>
  <body>
    <!-- ✅ TOP FIXED BANNER CON LOGO E LOGIN -->
    <div class="top-banner">
      <div class="logo" onclick="window.location.reload();">S</div>

      <div style="display: flex; align-items: center;">
      <div class="dr-name" id="drName"></div>
      <button class="login-btn" onclick="toggleAuthModal(true)">Log in / Register</button>
      </div>
    </div>

    <!-- ===== USER MENU CARD ===== -->
    <div id="sideMenu" class="user-menu" aria-hidden="true">
    <div class="user-menu-header">
      <div class="avatar" id="sideMenuAvatar">D</div>
      <div class="user-info">
        <!-- Populated by JS -->
        <div id="sideMenuName">Dr. —</div>
        <div id="sideMenuEmail" class="muted"></div>
      </div>
        <span class="plan-badge plan-free" id="planBadge">Free</span>
    </div>

    <div class="user-menu-section">
      <h4>ACCOUNT</h4>
      <button class="menu-item" onclick="openPersonalInfo()">
        <span class="icon">
          <!-- Profile -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M320 312C386.3 312 440 258.3 440 192C440 125.7 386.3 72 320 72C253.7 72 200 125.7 200 192C200 258.3 253.7 312 320 312zM290.3 368C191.8 368 112 447.8 112 546.3C112 562.7 125.3 576 141.7 576L498.3 576C514.7 576 528 562.7 528 546.3C528 447.8 448.2 368 349.7 368L290.3 368z"/></svg>
        </span> Personal Info
      </button>
      <button class="menu-item" id="remainingDownloadsBtn" type="button" onclick="openUpgradeModal()">
        <span class="icon" aria-hidden="true">
          <!-- Download icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M128 128C128 92.7 156.7 64 192 64L341.5 64C358.5 64 374.8 70.7 386.8 82.7L493.3 189.3C505.3 201.3 512 217.6 512 234.6L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 128zM336 122.5L336 216C336 229.3 346.7 240 360 240L453.5 240L336 122.5zM303 505C312.4 514.4 327.6 514.4 336.9 505L400.9 441C410.3 431.6 410.3 416.4 400.9 407.1C391.5 397.8 376.3 397.7 367 407.1L344 430.1L344 344C344 330.7 333.3 320 320 320C306.7 320 296 330.7 296 344L296 430.1L273 407.1C263.6 397.7 248.4 397.7 239.1 407.1C229.8 416.5 229.7 431.7 239.1 441L303.1 505z"/>
          </svg>
        </span>
        <span>Remaining Downloads</span>
        <span id="downloadCounter" style="margin-left:auto; font-weight:600;">0 / 8</span>
    </button>
    </div>

    <div class="user-menu-section">
      <h4>SUBSCRIPTION</h4>
      <button class="menu-item" onclick="openBillingInfo()">
        <span class="icon">
          <!-- Billing -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M142 66.2C150.5 62.3 160.5 63.7 167.6 69.8L208 104.4L248.4 69.8C257.4 62.1 270.7 62.1 279.6 69.8L320 104.4L360.4 69.8C369.4 62.1 382.6 62.1 391.6 69.8L432 104.4L472.4 69.8C479.5 63.7 489.5 62.3 498 66.2C506.5 70.1 512 78.6 512 88L512 552C512 561.4 506.5 569.9 498 573.8C489.5 577.7 479.5 576.3 472.4 570.2L432 535.6L391.6 570.2C382.6 577.9 369.4 577.9 360.4 570.2L320 535.6L279.6 570.2C270.6 577.9 257.3 577.9 248.4 570.2L208 535.6L167.6 570.2C160.5 576.3 150.5 577.7 142 573.8C133.5 569.9 128 561.4 128 552L128 88C128 78.6 133.5 70.1 142 66.2zM232 200C218.7 200 208 210.7 208 224C208 237.3 218.7 248 232 248L408 248C421.3 248 432 237.3 432 224C432 210.7 421.3 200 408 200L232 200zM208 416C208 429.3 218.7 440 232 440L408 440C421.3 440 432 429.3 432 416C432 402.7 421.3 392 408 392L232 392C208 402.7 218.7 416 232 416zM232 296C218.7 296 208 306.7 208 320C208 333.3 218.7 344 232 344L408 344C421.3 344 432 333.3 432 320C432 306.7 421.3 296 408 296L232 296z"/></svg>
        </span> Billing Info
      </button>
      <button class="menu-item" onclick="openUpgradePlan()">
        <span class="icon">
          <!-- Upgrade (replace this later with better SVG) -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M372.2 116C372.2 136.9 359.8 155 342 163.2L448 256L552.4 235.1C547.1 227.4 544 218 544 208C544 181.5 565.5 160 592 160C618.5 160 640 181.5 640 208C640 234 619.4 255.1 593.6 256L481 506.3C470.7 529.3 447.8 544 422.6 544L217.4 544C192.2 544 169.4 529.2 159 506.3L46.4 256C20.6 255.1 0 234 0 208C0 181.5 21.5 160 48 160C74.5 160 96 181.5 96 208C96 218.1 92.9 227.4 87.6 235.1L192 256L298.1 163.1C280.4 154.8 268.1 136.8 268.1 116C268.1 87.3 291.4 64 320.1 64C348.8 64 372.1 87.3 372.1 116z"/></svg>     
        </span> Upgrade Plan
      </button>
    </div>

    <div class="user-menu-section">
      <h4>SUPPORT</h4>
      <button class="menu-item" onclick="contactSupport()">
        <span class="icon">
          <!-- Contact -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/></svg>
        </span> Contact Support
      </button>
      <button class="menu-item" onclick="openTerms()">
        <span class="icon">
          <!-- Terms -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M128 128C128 92.7 156.7 64 192 64L341.5 64C358.5 64 374.8 70.7 386.8 82.7L493.3 189.3C505.3 201.3 512 217.6 512 234.6L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 128zM336 122.5L336 216C336 229.3 346.7 240 360 240L453.5 240L336 122.5zM248 320C234.7 320 224 330.7 224 344C224 357.3 234.7 368 248 368L392 368C405.3 368 416 357.3 416 344C416 330.7 405.3 320 392 320L248 320zM248 416C234.7 416 224 426.7 224 440C224 453.3 234.7 464 248 464L392 464C405.3 464 416 453.3 416 440C416 426.7 405.3 416 392 416L248 416z"/></svg>
        </span> Terms & Policies
      </button>
      <button class="menu-item logout" onclick="logoutUser()">
        <span class="icon">
          <!-- Logout -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M569 337C578.4 327.6 578.4 312.4 569 303.1L425 159C418.1 152.1 407.8 150.1 398.8 153.8C389.8 157.5 384 166.3 384 176L384 256L272 256C245.5 256 224 277.5 224 304L224 336C224 362.5 245.5 384 272 384L384 384L384 464C384 473.7 389.8 482.5 398.8 486.2C407.8 489.9 418.1 487.9 425 481L569 337zM224 160C241.7 160 256 145.7 256 128C256 110.3 241.7 96 224 96L160 96C107 96 64 139 64 192L64 448C64 501 107 544 160 544L224 544C241.7 544 256 529.7 256 512C256 494.3 241.7 480 224 480L160 480C142.3 480 128 465.7 128 448L128 192C128 174.3 142.3 160 160 160L224 160z"/></svg>
        </span> Log out
      </button>
    </div>
    </div>

    <div id="sideMenuBackdrop" class="side-menu-backdrop" onclick="toggleSideMenu(false)"></div>

    <!-- ===== LOGIN / REGISTER MODAL ===== -->
    <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal__close" aria-label="Close" onclick="toggleAuthModal(false)">×</button>

      <h2 id="authTitle" class="modal__title">Welcome to Symposia</h2>
      <p id="authSubtitle" class="modal__subtitle">Log in to generate your draft.</p>

    <!-- Provider buttons -->
    <div class="provider-stack">

    <!-- Google -->
    <button type="button" class="provider-btn" onclick="continueWithGoogle()">
      <span class="icon">
        <!-- Google icon -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="22px" height="22px" aria-hidden="true">
          <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12
            c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4
            C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20
            C44,22.659,43.862,21.35,43.611,20.083z"/>
          <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12
            c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4
            C16.318,4,9.656,8.337,6.306,14.691z"/>
          <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238
            C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025
            C9.505,39.556,16.227,44,24,44z"/>
          <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303
            c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238
            C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
        </svg>
      </span>
      <span>Log in with Google</span>
    </button>
    </div>

      <div class="hr-text"><span>or</span></div>

      <!-- Name fields (shown in Create account) -->
      <div id="nameFields" class="grid-2" style="display:none;">
        <div class="form-row">
        <label for="firstName">First name<span class="required-asterisk create-only">*</span></label>
          <input type="text" id="firstName" autocomplete="given-name" />
        </div>
        <div class="form-row">
        <label for="lastName">Last name<span class="required-asterisk create-only">*</span></label>
          <input type="text" id="lastName" autocomplete="family-name" />
        </div>
      </div>

      <!-- Email -->
      <div class="form-row">
        <label for="authEmail">Email<span class="required-asterisk create-only">*</span></label>
        <input type="email" id="authEmail" autocomplete="email" />
      </div>

      <!-- Password -->
    <div class="form-row">
    <label for="authPassword">Password<span class="required-asterisk create-only">*</span></label>

    <!-- relative wrapper so the eye button can be absolutely positioned -->
    <div class="password-wrap">
      <input
        type="password"
        id="authPassword"
        autocomplete="current-password"
      />

      <!-- the eye toggle lives INSIDE the wrapper -->
      <button
        type="button"
        class="password-toggle"
        aria-label="Show password"
        onclick="togglePassword('authPassword', this)"
      >
          <span class="eye">
        <!-- eye (open) -->
        <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M1 12C1 12 5 20 12 20C19 20 23 12 23 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="3" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
          </span>
        <span class="eye-off"> 
        <!-- eye (closed) -->
        <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 2L22 22" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6.71277 6.7226C3.66479 8.79527 2 12 2 12C2 12 5.63636 19 12 19C14.0503 19 15.8174 18.2734 17.2711 17.2884M11 5.05822C11.3254 5.02013 11.6588 5 12 5C18.3636 5 22 12 22 12C22 12 21.3082 13.3317 20 14.8335" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 14.2362C13.4692 14.7112 12.7684 15.0001 12 15.0001C10.3431 15.0001 9 13.657 9 12.0001C9 11.1764 9.33193 10.4303 9.86932 9.88818" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        </span>
      </button>
    </div>
    </div>

      <!-- Required field note, visible only in Create Account mode -->
    <p id="requiredNote" class="required-note">*required field</p>

    <!-- Forgot password (shown only in Login mode) -->
    <div class="forgot-row">
    <button id="forgotLink" class="forgot-password" type="button" onclick="startResetPassword()">
      Forgot password?
    </button>
    </div>

      <!-- Primary CTA -->
    <button id="primaryAuthBtn" class="btn btn-primary" type="button" onclick="handlePrimaryAuth()" disabled> Log in </button>


<div class="output-wrapper">
  <div id="output"></div>
  <div id="overlayBlockCopy"></div>
</div>

    <!-- Single download button -->
    <button id="downloadBtn">Download Draft</button>
  </div>

 <!-- === UPGRADE MODAL === -->
<div id="upgradeModal" class="modal" aria-hidden="true">
  <div class="modal__panel upgrade-modal">
    <button class="modal__close" aria-label="Close" onclick="closeUpgradeModal()">×</button>

    <!-- STEP 1: Plans -->
    <div class="upgrade-step" id="upgradeStep1">
      <div class="upgrade-left">
        <h2 class="modal__title">Choose Your Plan</h2>

        <div class="plan-card active" id="planPro" onclick="selectPlan('pro')">
          <h3>Pro</h3>
          <p>Unlimited downloads, premium speed, and advanced tools.</p>
        </div>

        <div class="plan-card disabled">
          <h3>Nobel</h3>
          <p>Coming soon — lifetime access to all features.</p>
        </div>
      </div>

      <div class="upgrade-right">
        <h2 class="modal__subtitle">Pro Benefits</h2>
        <ul class="benefits">
          <li>Unlimited draft downloads</li>
          <li>Priority AI generation</li>
          <li>Exclusive export formats (Word, PDF, PPTX)</li>
          <li>Custom image placement</li>
        </ul>

<!-- Plan Options - Month, Quarter, Annual -->
<div class="plan-option">
  <div class="plan-month active" data-plan="monthly" data-price="15">
    <div class="price-line">
      <span class="price">15</span><span class="euro">€</span>
    </div>
    <p class="period">/month</p>
  </div>
  <p class="note">15€ billed every month</p>

  <div class="plan-quarter" data-plan="quarterly" data-price="36">
    <div class="price-line">
      <span class="price">12</span><span class="euro">€</span>
    </div>
    <p class="period">/month</p>
  </div>
  <p class="note">36€ billed every 3 months</p>

  <div class="plan-year" data-plan="annual" data-price="108">
    <div class="price-line">
      <span class="price">9</span><span class="euro">€</span>
    </div>
    <p class="period">/month</p>
  </div>
  <p class="note">108€ billed yearly</p>
</div>

<div class="discount-section">
  <input type="text" id="discountCode" placeholder="Discount code">
  <button id="applyDiscountBtn">Apply</button>
    <p id="discountMessage"></p>
</div>

 <button id="continueToPayment" class="btn btn-primary">Continue</button>
</div>
   <!-- STEP 2: Payment -->
<div class="upgrade-step hidden" id="upgradeStep2">
  <div class="payment-header">
    <button id="backToPlan" class="back-btn" aria-label="Back to plans">
      ←
    </button>
    <h2 class="modal__title">Payment Details</h2>
  </div>

  <div class="payment-body">
    <div class="payment-left">
      <div class="card-stack">
        <div class="card visa"></div>
        <div class="card master"></div>
        <div class="card amex"></div>
      </div>
    </div>

    <div class="payment-right">
      <div class="payment-methods">
        <button>Google Pay</button>
        <button>Apple Pay</button>
        <button>PayPal</button>
      </div>

      <p class="or">or pay with card</p>

      <form id="paymentForm">
        <input type="text" placeholder="Card Number" required>
        <input type="text" placeholder="Card Holder Name" required>
        <div class="card-details">
          <input type="text" placeholder="MM / YY" required>
          <input type="text" placeholder="CVV" required>
        </div>
        <div class="total-line">
          <span>Total:</span>
          <strong id="totalAmount">€15</strong>
        </div>
        <button type="submit" class="btn btn-primary">Pay Now</button>
      </form>
    </div>
  </div>
</div>
</div>
      <!-- Footer: switch mode -->
      <div class="modal__footer">
        <span id="authModeText">Don’t have an account?</span>
        <button id="switchAuthModeBtn" class="link" type="button" onclick="switchAuthMode(true)">Create one</button>
      </div>
    </div>
    </div>


    <div class="container">
      <h1>Symposia</h1>
      <p class="subtitle">Turn your clinical notes into publishable drafts</p>

      <label for="notes">Enter Your Notes</label>
      <textarea id="notes" rows="6" placeholder="Please type your notes here..."></textarea>
      
      <label style="margin-top: 20px; margin-bottom: 10px; display: block;">Add Images</label>
      <div id="imageSlots" class="image-slots" style="margin-bottom: 30px;"></div>
      

      <label>Choose Format</label>
      <div class="format-buttons">
        <button data-format="Abstract" class="active">Abstract</button>
        <button data-format="Case Report">Case Report</button>
        <button data-format="Presentation">Presentation</button>
        <button data-format="Research">Research</button>
      </div>

      <button id="generateBtn">Generate Draft</button>
      <div id="loading">
    <div class="spinner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    </div>

    <div class="output-wrapper">
    <div id="output"></div>
    <div id="overlayBlockCopy"></div>
    </div>

      <!-- Single download button -->
      <button id="downloadBtn">Download Draft</button>
    </div>

    <!-- === UPGRADE MODAL === -->
    <div id="upgradeModal" class="modal" aria-hidden="true">
    <div class="modal__panel upgrade-modal">
      <button class="modal__close" aria-label="Close" onclick="closeUpgradeModal()">×</button>

      <!-- STEP 1: Plans -->
      <div class="upgrade-step" id="upgradeStep1">
        <div class="upgrade-left">
          <h2 class="modal__title">Choose Your Plan</h2>

          <div class="plan-card active" id="planPro" onclick="selectPlan('pro')">
            <h3>Pro</h3>
            <p>Unlimited downloads, premium speed, and advanced tools.</p>
          </div>

          <div class="plan-card disabled">
            <h3>Nobel</h3>
            <p>Coming soon — lifetime access to all features.</p>
          </div>
        </div>

        <div class="upgrade-right">
          <h2 class="modal__subtitle">Pro Benefits</h2>
          <ul class="benefits">
            <li>Unlimited draft downloads</li>
            <li>Priority AI generation</li>
            <li>Exclusive export formats (Word, PDF, PPTX)</li>
            <li>Custom image placement</li>
          </ul>

          <div class="billing-options">
            <label><input type="radio" name="billing" value="monthly" checked> Monthly — <span class="price">€15</span></label>
            <label><input type="radio" name="billing" value="quarterly"> Quarterly — <span class="price">€12</span>/month (billed €36)</label>
            <label><input type="radio" name="billing" value="annual"> Annual — <span class="price">€8.99</span>/month (billed €107.88)</label>
          </div>

          <div class="discount-section">
            <input type="text" id="discountCode" placeholder="Discount code">
            <button id="applyDiscountBtn">Apply</button>
            <p id="discountMessage"></p>
          </div>

          <button id="continueToPayment" class="btn btn-primary">Continue</button>
        </div>
      </div>

      <!-- STEP 2: Payment -->
      <div class="upgrade-step hidden" id="upgradeStep2">
        <div class="payment-left">
          <h2 class="modal__title">Payment Details</h2>
          <div class="card-stack">
            <div class="card visa"></div>
            <div class="card master"></div>
            <div class="card amex"></div>
          </div>
        </div>

        <div class="payment-right">
          <div class="payment-methods">
            <button>Google Pay</button>
            <button>Apple Pay</button>
            <button>PayPal</button>
          </div>

          <p class="or">or pay with card</p>

          <form id="paymentForm">
            <input type="text" placeholder="Card Number" required>
            <input type="text" placeholder="Card Holder Name" required>
            <div class="card-details">
              <input type="text" placeholder="MM / YY" required>
              <input type="text" placeholder="CVV" required>
            </div>
            <div class="total-line">
              <span>Total:</span>
              <strong id="totalAmount">€15</strong>
            </div>
            <button type="submit" class="btn btn-primary">Pay Now</button>
          </form>
        </div>
      </div>
    </div>
    </div>


    <script>
      const generateBtn   = document.getElementById('generateBtn');
      const loading       = document.getElementById('loading');
      const output        = document.getElementById('output');
      const downloadBtn   = document.getElementById('downloadBtn');
      const formatButtons = document.querySelectorAll('.format-buttons button');

      let selectedFormat = 'Abstract'; // default

      // Format selection
      formatButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          formatButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedFormat = btn.dataset.format || 'Abstract';
        });
      });

    // Image Slots 
    const imageSlots = document.getElementById('imageSlots');
    const imageList = [];

    const MAX_IMAGES = 5;
    const MAX_CAPTION_LENGTH = 500;

    for (let i = 0; i < MAX_IMAGES; i++) {
    const slot = document.createElement('div');
    slot.classList.add('image-slot');

    const plus = document.createElement('span');
    plus.textContent = '+';
    plus.style.fontSize = '2rem';
    plus.style.color = '#475569';
    slot.appendChild(plus);

    slot.addEventListener('click', () => openImageModal(i));
    imageSlots.appendChild(slot);
    }

      // Generate draft
      generateBtn.addEventListener('click', async () => {
        const notes = document.getElementById('notes')?.value || '';
        if (!notes.trim()) {
          alert('Please enter some notes.');
          return;
        }

        // reset UI
        generateBtn.disabled = true;
        loading.style.display = 'block';
        output.textContent = '';
        downloadBtn.style.display = 'none';

        // Add rotating status messages
        const statusMessages = [
        "Organizing your notes…",
        "Preparing data…",
        "Structuring the document…",
        "Just a few more seconds…"
        ];

    let i = 0;
    const statusEl = document.createElement('p');
    statusEl.id = 'statusText';
    statusEl.style.color = '#2563eb';
    statusEl.style.fontWeight = '600';
    statusEl.style.marginTop = '10px';
    statusEl.textContent = statusMessages[i];
    loading.appendChild(statusEl);
    
    const statusInterval = setInterval(() => {
      i = (i + 1) % statusMessages.length;
      statusEl.textContent = statusMessages[i];
    }, 5000);
        
    try {
    // API call
    const imageCaptions = imageList
      .filter(img => img && img.caption)
      .map((img, i) => `Image ${i + 1} (${img.name}): ${img.caption}`);

    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        notes,
        format: selectedFormat,
        image_captions: imageCaptions
      })
    });

    const data = await response.json();
    if (!response.ok || data.error) {
      output.textContent = 'Error: ' + (data?.error?.message || data.error || JSON.stringify(data));
    } else {
      let draftText = (data.draft || data.result || '').trim();
      // Remove dangling empty "Recommended Additions"
      draftText = draftText.replace(/Recommended Additions\s*$/i, "");
      // Bold the main "Recommended Additions"
      draftText = draftText.replace(/(Recommended Additions)/gi, '🔷 <strong>$1</strong>');
      output.innerHTML = `<div style="font-family:'Times New Roman', Times, serif;">${draftText.trim()}</div>` || 'No draft returned.';
      output.innerHTML = draftText.trim() || 'No draft returned.';
      if (draftText) 
        downloadBtn.style.display = 'block';
      // Prevent text selection (disables copying)
      if (typeof window.updateDownloadButtonState === 'function') {
        window.updateDownloadButtonState(window.auth?.currentUser || null);
      } else {
      // ritenta brevemente se il module non è ancora pronto
        setTimeout(() => window.updateDownloadButtonState?.(window.auth?.currentUser || null), 150);
      }
    }
    } catch (err) {
      output.textContent = 'Error generating draft: ' + (err?.message || String(err));
    } finally {
      clearInterval(statusInterval);
      const st = document.getElementById('statusText');
      if (st) st.remove();
      loading.style.display = 'none';
      generateBtn.disabled = false;
    }
});

    // Image upload Modal logic
    const modal = document.createElement('div');
    modal.style.display = 'none';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '9999';

    modal.innerHTML = `
    <div style="background: white; padding: 20px; border-radius: 12px; width: 300px; max-width: 90%;">
      <h3 style="margin-top: 0; text-align: center; color: #2563eb;">Upload Image</h3>

      <!-- Image preview (only shown in edit mode) -->
      <div id="modalImagePreview" style="text-align: center; margin-bottom: 10px; display: none;">
        <img id="modalImageTag" src="" style="max-width: 100%; max-height: 150px; border-radius: 6px;" />
      </div>

      <!-- File input (only shown when uploading new or changing) -->
      <input type="file" accept="image/*" id="modalImageInput" style="margin-bottom: 10px;" />

      <!-- Change Image Button (only shown in edit mode) -->
      <button id="changeImageBtn" type="button" style="display: none; background-color: #e2e8f0; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
        Change Image
      </button>

      <textarea id="modalCaption" rows="3" placeholder="Describe the image..." style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; resize: none;"></textarea>
      <div id="charCount" style="text-align: right; font-size: 0.85rem; color: #64748b; margin-top: 4px;">0/500</div>

      <div style="text-align: center; margin-top: 12px;">
        <button id="modalConfirmBtn" disabled style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; opacity: 0.6;">Confirm</button>
      </div>
    </div>
    `;

    document.body.appendChild(modal);

      const changeImageBtn = document.getElementById('changeImageBtn');
    const modalImageInput = document.getElementById('modalImageInput');

    if (changeImageBtn && modalImageInput) {
    changeImageBtn.addEventListener('click', () => {
      modalImageInput.click(); // Simulates click on the hidden input
    });
    }

      // Chiudi il modal cliccando fuori dal box interno
    modal.addEventListener('click', (e) => {
    // Se l'utente clicca sullo sfondo scuro (non sul contenuto interno)
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    let activeSlotIndex = null;
    let activeImageFile = null;

    function openImageModal(index) {
    activeSlotIndex = index;
    const existing = imageList[index];

    const modalInput = document.getElementById('modalImageInput');
    const modalCaption = document.getElementById('modalCaption');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    const charCount = document.getElementById('charCount');
    const modalImagePreview = document.getElementById('modalImagePreview');
    const modalImageTag = document.getElementById('modalImageTag');
    const changeImageBtn = document.getElementById('changeImageBtn');

    activeImageFile = null;
    modalInput.value = '';

    if (existing) {
      modalCaption.value = existing.caption || '';
      charCount.textContent = `${existing.caption.length}/500`;
      charCount.style.color = existing.caption.length > MAX_CAPTION_LENGTH ? 'red' : '#64748b';
      confirmBtn.disabled = false;
      confirmBtn.style.opacity = 1;

      // Show preview
      modalImagePreview.style.display = 'block';
      modalImageTag.src = imageSlots.children[index].querySelector('img')?.src || '';
      modalInput.style.display = 'none';
      changeImageBtn.style.display = 'inline-block';
    } else {
      modalCaption.value = '';
      charCount.textContent = `0/500`;
      charCount.style.color = '#64748b';
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = 0.6;

      modalImagePreview.style.display = 'none';
      modalInput.style.display = 'block';
      changeImageBtn.style.display = 'none';
    }

    modal.style.display = 'flex';
    }

    // Enable confirm only when caption is filled
    document.getElementById('modalCaption').addEventListener('input', (e) => {
    const val = e.target.value;
    const trimmed = val.trim();
    const btn = document.getElementById('modalConfirmBtn');
    const countDisplay = document.getElementById('charCount');

    // Aggiorna contatore
    countDisplay.textContent = `${val.length}/${MAX_CAPTION_LENGTH}`;

    // Cambia colore in rosso se sopra limite
    countDisplay.style.color = val.length > MAX_CAPTION_LENGTH ? 'red' : '#64748b';

    // Disattiva Confirm se vuoto o sopra limite
    btn.disabled = trimmed.length === 0 || val.length > MAX_CAPTION_LENGTH;
    btn.style.opacity = btn.disabled ? 0.6 : 1;
    });

    document.getElementById('modalImageInput').addEventListener('change', (e) => {
    activeImageFile = e.target.files[0];

      // Update preview image in modal
    const preview = document.getElementById('modalImageTag');
    if (preview && activeImageFile) {
    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      document.getElementById('modalImagePreview').style.display = 'block';
    };
    reader.readAsDataURL(activeImageFile);
    }

    });

    document.getElementById('modalConfirmBtn').addEventListener('click', () => {
    const caption = document.getElementById('modalCaption').value.trim();

    // ✅ CASE 1: Editing an existing image (no new image selected)
    if (!activeImageFile && imageList[activeSlotIndex]) {
      // Just update caption and close modal
      imageList[activeSlotIndex].caption = caption;
      modal.style.display = 'none';
      return;
    }

    // ❌ CASE 2: Trying to confirm without any image at all
    if (!activeImageFile) return;

    // ✅ CASE 3: New image selected (your current logic)
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result;

      // Store metadata only (still skipping base64 for now)
      imageList[activeSlotIndex] = {
        name: activeImageFile.name,
        caption: caption
      };

      const slot = imageSlots.children[activeSlotIndex];
      slot.innerHTML = '';
      slot.style.position = 'relative';

      // Create image preview
      const img = document.createElement('img');
      img.src = base64;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '8px';
      slot.appendChild(img);

      // Create remove button
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.className = 'remove-btn';

      // On remove: clear slot, reset imageList
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent modal from opening
        imageList[activeSlotIndex] = null; // Clear metadata
        slot.innerHTML = '';

        const plus = document.createElement('span');
        plus.textContent = '+';
        plus.style.fontSize = '2rem';
        plus.style.color = '#475569';
        slot.appendChild(plus);
      });

      slot.appendChild(removeBtn);
      modal.style.display = 'none';
    };

    reader.readAsDataURL(activeImageFile);
    });
    </script>

    <script>
    let isRegisterMode = false;

    // Open/close modal. mode: 'login' | 'register'
    function toggleAuthModal(show = true, mode = 'login') {
    const modal = document.getElementById('authModal');
    if (!modal) return;
    modal.style.display = '';  // <-- clear inline style so CSS classes win

    if (show) {
      modal.classList.add('open');
      switchAuthMode(mode === 'register');
    } else {
      modal.classList.remove('open');
    }
    }

    // Close on ESC
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') toggleAuthModal(false);
    });

    // Close when clicking the backdrop
    document.getElementById('authModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'authModal') toggleAuthModal(false);
    });

    // Switch between Login and Create account
    function switchAuthMode(toRegister) {
      isRegisterMode = !!toRegister;
      updateRequiredIndicators(isRegisterMode);

      // Show/hide name fields
      const nameFields = document.getElementById('nameFields');
      if (nameFields) nameFields.style.display = isRegisterMode ? 'grid' : 'none';

      // Update headings/subhead
      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      if (title) title.textContent = isRegisterMode
        ? 'Create your Symposia account'
        : 'Welcome to Symposia';
      if (subtitle) subtitle.textContent = isRegisterMode
        ? 'A few details to get started.'
        : 'Log in to generate your draft.';

      // Primary button label
      const primaryBtn = document.getElementById('primaryAuthBtn');
      if (primaryBtn) primaryBtn.textContent = isRegisterMode ? 'Create account' : 'Log in';

      // Forgot password — hide in register, show in login
      const forgot = document.getElementById('forgotLink');
      if (forgot) forgot.style.display = isRegisterMode ? 'none' : 'inline-block';

      // Switcher line
      const modeText = document.getElementById('authModeText');
      if (modeText) modeText.textContent = isRegisterMode
        ? 'Already have an account?'
        : 'Don’t have an account?';

      const switchBtn = document.getElementById('switchAuthModeBtn');
      if (switchBtn) {
        switchBtn.textContent = isRegisterMode ? 'Log in' : 'Create one';
        switchBtn.setAttribute('onclick', `switchAuthMode(${!isRegisterMode})`);
      }

        const requiredEls = document.querySelectorAll('.requiredOnly');
        requiredEls.forEach(el => {
        el.style.display = isRegisterMode ? 'inline' : 'none';
      });

      // show/hide grey note under password
      const requiredNote = document.getElementById('requiredNote');
      if (requiredNote) {
      requiredNote.style.display = isRegisterMode ? 'block' : 'none';
      }
    }

    // Show/hide password (single correct version)
    function togglePassword(inputId, btnEl) {
      const input = document.getElementById(inputId);
      if (!input) return;
      const willShowText = (input.type === 'password'); // switching TO text
      input.type = willShowText ? 'text' : 'password';

      // “is-on” means eye is OPEN (text visible)
      if (btnEl) {
        btnEl.classList.toggle('is-on', willShowText);
        btnEl.setAttribute('aria-label', willShowText ? 'Hide password' : 'Show password');
        btnEl.setAttribute('aria-pressed', String(willShowText));
      }
    }

    function updateRequiredIndicators(isRegisterMode) {
    const requiredLabels = [
      { labelId: 'firstName', labelText: 'First name' },
      { labelId: 'lastName', labelText: 'Last name' },
      { labelId: 'authEmail', labelText: 'Email' },
      { labelId: 'authPassword', labelText: 'Password' }
    ];

    requiredLabels.forEach(({ labelId, labelText }) => {
      const label = document.querySelector(`label[for="${labelId}"]`);
      if (label) {
        label.innerHTML = isRegisterMode
          ? `${labelText} <span style="color:#999;">*</span>`
          : labelText;
      }
    });

    const requiredNote = document.getElementById('requiredNote');
    if (requiredNote) {
      requiredNote.style.display = isRegisterMode ? 'block' : 'none';
    }
    }

    function toggleSideMenu(show) {
    const menu = document.getElementById('sideMenu');
    const backdrop = document.getElementById('sideMenuBackdrop');
    if (!menu || !backdrop) return;

    if (show) {
      menu.classList.add('open');
      backdrop.classList.add('open');
    } else {
      menu.classList.remove('open');
      backdrop.classList.remove('open');
    }
    }

    // close on ESC too
    window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleSideMenu(false);
    });

    // stub handlers (to be implemented later)
    function openPersonalInfo(){ alert('Personal Info — coming soon'); }
    function openBilling(){ alert('Billing Info — coming soon'); }
    function openUpgrade(){ alert('Upgrade — coming soon'); }
    function openMyDrafts(){ alert('My Drafts — coming soon'); }
    function openDownloadHistory(){ alert('Download History — coming soon'); }
    function openHelp(){ alert('Help / Docs — coming soon'); }
    function contactSupport(){ window.location.href = 'mailto:support@symposia.ai'; }
    function openPrivacy(){ alert('Privacy Policy — coming soon'); }
    function openTerms(){ alert('Terms of Service — coming soon'); }
    </script>

    <script type="module">

    // ===== Firebase SDK Setup =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    sendPasswordResetEmail,
    onAuthStateChanged,
    updateProfile,
    signOut,
    getAdditionalUserInfo
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ===== Firebase Config =====
    const firebaseConfig = {
    apiKey: "AIzaSyAcjqnPesz2gb_tChRePmQs_Z7g_TiknUE",
    authDomain: "symposia-6411a.firebaseapp.com",
    projectId: "symposia-6411a",
    storageBucket: "symposia-6411a.firebasestorage.app",
    messagingSenderId: "764049033413",
    appId: "1:764049033413:web:a14022bac19894322dc8ac"
    };

    // ===== Initialize Firebase =====
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app); // Firestore instance

    // expose globally
    window.toggleSideMenu = toggleSideMenu;
    window.openPersonalInfo = openPersonalInfo;
    window.openBilling = openBilling;
    window.openUpgrade = openUpgrade;
    window.openMyDrafts = openMyDrafts;
    window.openDownloadHistory = openDownloadHistory;
    window.openHelp = openHelp;
    window.contactSupport = contactSupport;
    window.openPrivacy = openPrivacy;
    window.openTerms = openTerms;
    window.auth = auth;
    window.fetchDownloadCount = fetchDownloadCount;
    window.saveDownloadCountToCloud = saveDownloadCountToCloud;
    window.toggleAuthModal = toggleAuthModal;
    window.switchAuthMode = switchAuthMode;
    window.handlePrimaryAuth = handlePrimaryAuth;
    window.continueWithGoogle = continueWithGoogle;
    window.startResetPassword = startResetPassword;
    window.logoutUser = logoutUser;
    window.bindDownloadButton = window.bindDownloadButton || bindDownloadButton;
    window.updateDownloadButtonState = window.updateDownloadButtonState || updateDownloadButtonState;

    // ===== Auth State Listener =====
    onAuthStateChanged(auth, (user) => {
      const loginBtn = document.querySelector('.login-btn');
      const drNameEl = document.getElementById('drName');
      if (user) {
        updateUserUI(user);
        if (loginBtn) { loginBtn.style.display = 'none'; loginBtn.style.visibility = 'visible'; }
        if (drNameEl) { drNameEl.style.display = 'inline-block'; drNameEl.style.visibility = 'visible'; }

        // 🔹 Sync download count on login
        fetchDownloadCount(user.email).then((count) => updateDownloadCounterUI(count));

      } else {
        if (drNameEl) { drNameEl.textContent = ''; drNameEl.style.display = 'none'; drNameEl.style.visibility = 'visible'; }
        if (loginBtn)  { loginBtn.style.display = 'inline-block'; loginBtn.style.visibility = 'visible'; }
        toggleSideMenu(false);
      }
      if (typeof updateDownloadButtonState === 'function') {
        updateDownloadButtonState(user || null);
      }
      if (typeof bindDownloadButton === 'function') {
        bindDownloadButton();
      }
    });

    // === 🔹 FIRESTORE SYNC HELPERS ===
    async function fetchDownloadCount(userEmail) {
    if (!userEmail) return 0;
    try {
      const ref = doc(db, "userDownloads", userEmail);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().count || 0 : 0;
    } catch (err) {
      console.error("Error fetching download count:", err);
      return 0;
    }
    }

    async function saveDownloadCountToCloud(userEmail, count) {
    if (!userEmail) return;
    try {
      const ref = doc(db, "userDownloads", userEmail);
      await setDoc(ref, { count }, { merge: true });
    } catch (err) {
      console.error("Error saving download count:", err);
    }
    }

    // ===== Google Provider =====
    const googleProvider = new GoogleAuthProvider();

    // ===== Primary Auth Action =====
    async function handlePrimaryAuth() {
    const email = document.getElementById('authEmail')?.value.trim();
    const password = document.getElementById('authPassword')?.value.trim();
    if (!email || !password) return alert('Please enter email and password.');

    try {
      if (isRegisterMode) {
        const first = document.getElementById('firstName')?.value.trim() || '';
        const last  = document.getElementById('lastName')?.value.trim() || '';
        const { user } = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(user, { displayName: `${first} ${last}` });

        localStorage.setItem('userFirstName', first);
        localStorage.setItem('userLastName',  last);
        localStorage.setItem('userEmail', user.email);

        alert(`✅ Registered as ${user.email}`);
        document.getElementById('authModal').style.display = 'none';
        document.querySelector('.login-btn').style.display = 'none';
        updateUserUI(user);
      } else {
        const { user } = await signInWithEmailAndPassword(auth, email, password);
        localStorage.setItem('userEmail', user.email);

        if (user.displayName) {
          const parts = user.displayName.trim().split(/\s+/);
          const first = parts[0] || '';
          const last  = parts.length > 1 ? parts[parts.length - 1] : '';
          if (first) localStorage.setItem('userFirstName', first);
          if (last)  localStorage.setItem('userLastName',  last);
        }

        alert(`✅ Logged in as ${user.email}`);
        document.getElementById('authModal').style.display = 'none';
        document.querySelector('.login-btn').style.display = 'none';
        updateUserUI(user);
      }
    } catch (err) {
      alert(`❌ ${err.message}`);
    }
    }

    // ===== Google Sign-In =====
    function continueWithGoogle() {
    signInWithPopup(auth, googleProvider)
      .then((result) => {
        const user = result.user;
        const info = getAdditionalUserInfo(result);
        const profile = info?.profile || {};

        let first = profile.given_name || profile.givenName || profile.first_name || '';
        let last  = profile.family_name || profile.familyName || profile.last_name || '';

        if ((!first && !last) && user.displayName) {
          const parts = user.displayName.trim().split(/\s+/);
          if (parts.length === 1) first = parts[0];
          else { first = parts[0]; last = parts[parts.length - 1]; }
        }

        if (first) localStorage.setItem('userFirstName', first);
        if (last)  localStorage.setItem('userLastName',  last);
        localStorage.setItem('userEmail', user.email);

        alert(`Signed in with Google: ${user.email}`);

        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';

        const loginBtn = document.querySelector('.login-btn');
        if (loginBtn) loginBtn.style.display = 'none';

        updateUserUI(user);
      })
      .catch((error) => {
        console.error(error);
        alert(`❌ Google login error:\n${error.message}`);
      });
    }

    // ===== Update User UI =====
    function updateUserUI(user) {
    const loginBtn  = document.querySelector('.login-btn');
    const drNameEl  = document.getElementById('drName');
    const sideName  = document.getElementById('sideMenuName');
    const sideEmail = document.getElementById('sideMenuEmail');
    const avatarEl  = document.getElementById('sideMenuAvatar');

    if (loginBtn) loginBtn.style.display = 'none';
    if (!drNameEl || !user) return;

    const isMobile = window.innerWidth <= 768;

    let first = (localStorage.getItem('userFirstName') || '').trim();
    let last  = (localStorage.getItem('userLastName')  || '').trim();

    if ((!first && !last) && user.displayName) {
      const parts = user.displayName.trim().split(/\s+/);
      if (parts.length === 1) {
        first = parts[0];
      } else {
        first = parts[0];
        last  = parts[parts.length - 1];
      }
    }

    if (!first && user.email) first = user.email.split('@')[0];

    const surname = last || first || '';
    const label = surname
      ? (isMobile ? `Dr. ${surname.charAt(0).toUpperCase()}.` : `Dr. ${surname}`)
      : 'Dr.';

    drNameEl.textContent = label;
    drNameEl.style.display = 'inline-block';
    drNameEl.style.visibility = 'visible';
    drNameEl.onclick = () => toggleSideMenu(true);

    if (sideName)  sideName.textContent  = `Dr. ${last || first || ''}`;
    if (sideEmail) sideEmail.textContent = user.email || '';
    if (avatarEl)  avatarEl.textContent  = (first?.[0] || 'D').toUpperCase();
    }

    // ===== Update Plan Badge =====
    function updatePlanBadge(plan) {
    const badge = document.getElementById('planBadge');
    if (!badge) return;
    badge.textContent = plan;
    badge.classList.remove('plan-free', 'plan-pro', 'plan-nobel');
    switch (plan.toLowerCase()) {
      case 'pro':   badge.classList.add('plan-pro'); break;
      case 'nobel': badge.classList.add('plan-nobel'); break;
      default:      badge.classList.add('plan-free'); break;
    }
    }

    // ===== Password Reset =====
    function startResetPassword() {
    const email = document.getElementById('authEmail')?.value.trim();
    if (!email) return alert('Enter your email first.');
    sendPasswordResetEmail(auth, email)
      .then(() => alert(`Password reset email sent to: ${email}`))
      .catch((error) => {
        console.error(error);
        alert(`Error:\n${error.message}`);
      });
    }

    // ===== Logout =====
    function logoutUser() {
    signOut(auth)
      .then(() => {
        alert("🚪 Logged out successfully!");
        const loginBtn = document.querySelector('.login-btn');
        const drName   = document.getElementById('drName');
        if (loginBtn) {
          loginBtn.style.display = 'inline-block';
          loginBtn.style.visibility = 'visible';
          loginBtn.onclick = () => toggleAuthModal(true);
        }
        if (drName) {
          drName.textContent = '';
          drName.style.display = 'none';
        }
        localStorage.removeItem("userEmail");
        toggleSideMenu(false);
      })
      .catch((error) => {
        console.error("Logout error:", error);
        alert(`Logout error:\n${error.message}`);
      });
    }

    // === ENSURE DOWNLOAD BUTTON ALWAYS WORKS AND COUNTS SYNC ===
    async function updateDownloadCounterUI(count) {
    const counter = document.getElementById("downloadCounter");
    if (counter) counter.textContent = `${count} / 8`;
    }

    // --- Stato/abilitazione del pulsante download ---
    function updateDownloadButtonState(user) {
      const btn = document.getElementById('downloadBtn');
      if (!btn) return;
      const hasDraft = (document.getElementById('output')?.textContent || '').trim().length > 0;
      // Se non autenticato → disabilita ed invita a login
      btn.disabled = !hasDraft;
      btn.title = !user ? 'Log in to download drafts' : (!hasDraft ? 'Generate a draft first' : '');
    }
    window.updateDownloadButtonState = updateDownloadButtonState;

    // Attach listener every time the button (re)appears
    function bindDownloadButton() {
      const downloadBtn = document.getElementById("downloadBtn");
      if (!downloadBtn || downloadBtn.dataset.bound === "true") return;
      downloadBtn.dataset.bound = "true"; // avoid double binding

      downloadBtn.addEventListener("click", async () => {
        const content = document.getElementById("output")?.textContent || "";
        if (!content.trim()) {
          alert("No draft available to download.");
          return;
        }

      const user = auth.currentUser;
      if (!user) {
        if (typeof toggleAuthModal === 'function') toggleAuthModal(true, 'login');
        else document.getElementById('authModal')?.classList.add('open');
        return;
      }

      let count = 0;
      try {
        count = await fetchDownloadCount(user.email);
      } catch (err) {
        console.error("Error fetching download count:", err);
        alert("Error checking download limit. Please try again later.");
      }

      // limit check before proceeding
      if (count >= 8) {
        if (typeof openUpgradeModal === "function") openUpgradeModal();
        else window.openUpgradeModal?.();
        return;
      }

      // proceed with download
      const blob = new Blob(["\ufeff", content], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "symposia_draft.docx";
      document.body.appendChild(a);
      a.click();
      a.remove()
      URL.revokeObjectURL(url);

      // increment and sync
      count += 1;
      try { await saveDownloadCountToCloud(user.email, count); } catch (err) { console.error('saveDownloadCountToCloud error', err); }
      if (typeof updateDownloadCounterUI === 'function') updateDownloadCounterUI(count);

      updateDownloadButtonState(auth.currentUser);
    }, {capture : true});
    }

    window.bindDownloadButton = bindDownloadButton;

    document.addEventListener('DOMContentLoaded', () => {
    bindDownloadButton();
    // inizializza stato bottone
    updateDownloadButtonState(auth.currentUser || null);
    });

    // Observe DOM for changes (if UI regenerates after draft generation)
    const observer = new MutationObserver(() => bindDownloadButton());
    observer.observe(document.body, { childList: true, subtree: true });

    // initial bind on load
    bindDownloadButton();

    document.getElementById('authModal').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && this.style.display !== 'none') {
      e.preventDefault();
      handlePrimaryAuth();
    }
    });

// --- Auth-based sync ---
	onAuthStateChanged(auth, async (user) => {
	  if (user && user.email) {
	    currentEmail = user.email;
	    keyName = `downloadCount_${currentEmail}`;
	    const local = parseInt(localStorage.getItem(keyName) || "0", 10);
	    const cloud = await fetchDownloadCount(currentEmail);
	    downloadCount = Math.max(local, cloud);
	    localStorage.setItem(keyName, String(downloadCount));
	  } else {
	    currentEmail = null;
	    keyName = "downloadCount_guest";
	    downloadCount = parseInt(localStorage.getItem(keyName) || "0", 10);
	  }
	  syncDownloadUI();
	});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  // === Upgrade Modal Logic ===
  function openUpgradeModal() {
    const modal = document.getElementById("upgradeModal");
    if (!modal) return;
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
  }

  function closeUpgradeModal() {
    const modal = document.getElementById("upgradeModal");
    if (!modal) return;
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
  }

  // === Plan card selection (Pro, Nobel) ===
  function selectPlan(plan) {
    const planPro = document.getElementById("planPro");
    if (plan === "pro" && planPro) {
      planPro.classList.add("active");
    }
  }

  // === Step navigation: Plan → Payment ===
  const continueBtn = document.getElementById("continueToPayment");
  const step1 = document.getElementById("upgradeStep1");
  const step2 = document.getElementById("upgradeStep2");
  const totalEl = document.getElementById("totalAmount");

  if (continueBtn && step1 && step2) {
    continueBtn.addEventListener("click", () => {
      console.log("✅ Continue clicked");

      step1.classList.add("hidden");
      step2.classList.remove("hidden");
      step2.scrollIntoView({ behavior: "smooth" });
    });
  }

  // === Back arrow in Payment step ===
  const backBtn = document.getElementById("backToPlan");
  if (backBtn && step1 && step2) {
    backBtn.addEventListener("click", () => {
      step2.classList.add("hidden");
      step1.classList.remove("hidden");
      step1.scrollIntoView({ behavior: "smooth" });
    });
  }

  // === Discount logic ===
  const discountBtn = document.getElementById("applyDiscountBtn");
  if (discountBtn) {
    discountBtn.addEventListener("click", () => {
      const code = document.getElementById("discountCode").value.trim().toLowerCase();
      const msg = document.getElementById("discountMessage");
      const total = document.getElementById("totalAmount");

      if (code === "symposia10") {
        msg.textContent = "10% discount applied!";
        total.textContent = "€13.50";
      } else if (code === "symposia25") {
        msg.textContent = "25% discount applied!";
        total.textContent = "€11.25";
      } else {
        msg.textContent = "Invalid code.";
      }
    });
  }

  // === Connect all modal triggers ===
  document.querySelector("#remainingDownloadsBtn")?.addEventListener("click", openUpgradeModal);
  document.querySelector(".menu-item[onclick='openUpgradePlan()']")?.addEventListener("click", openUpgradeModal);

  // === Billing option selection + price update ===
  const planOptions = document.querySelectorAll(".plan-month, .plan-quarter, .plan-year");
  planOptions.forEach(opt => {
    opt.addEventListener("click", () => {
      planOptions.forEach(o => o.classList.remove("active"));
      opt.classList.add("active");

      const plan = opt.dataset.plan;
      let price = 15;
      if (plan === "quarterly") price = 36;
      if (plan === "annual") price = 108;

      if (totalEl)
        totalEl.textContent = `€${price.toFixed(2).replace(".00", "")}`;
    });
  });
});
  document.addEventListener("DOMContentLoaded", () => {
  const step1 = document.getElementById("upgradeStep1");
  const step2 = document.getElementById("upgradeStep2");
  const continueBtn = document.getElementById("continueToPayment");
  const backBtn = document.getElementById("backToPlan");

  if (continueBtn && step1 && step2) {
    continueBtn.addEventListener("click", () => {
      console.log("✅ Continue clicked");
      step1.classList.add("hidden");
      step2.classList.remove("hidden");
    });
  }

  if (backBtn && step1 && step2) {
    backBtn.addEventListener("click", () => {
      step2.classList.add("hidden");
      step1.classList.remove("hidden");
    });
  }
});
</script>


    <script>
    document.addEventListener("DOMContentLoaded", () => {
    const primaryBtn = document.getElementById("primaryAuthBtn");
    const fields = [
      document.getElementById("authEmail"),
      document.getElementById("authPassword"),
      document.getElementById("firstName"),
      document.getElementById("lastName")
    ];

    function checkFields() {
      // if register mode → require first+last+email+password
      // if login mode → require only email+password
      const requireName = isRegisterMode; // <-- uses your existing flag
      const filled = fields.every(f => {
        if (!f) return true; // ignore missing fields
        if (requireName && (f.id === "firstName" || f.id === "lastName")) {
          return f.value.trim() !== "";
        }
        if (f.id === "authEmail" || f.id === "authPassword") {
          return f.value.trim() !== "";
        }
        return true;
      });

      primaryBtn.disabled = !filled;
    }

    fields.forEach(f => {
      if (f) f.addEventListener("input", checkFields);
    });

    checkFields(); // run once at start
    });

    </script>
    
    <script>
    function openUpgradeModal() {
      const m = document.getElementById('upgradeModal');
      if (!m) return;
      m.style.display = '';              // clear inline if any
      m.classList.add('open');           // your CSS uses `.modal.open { display:block }`
      m.setAttribute('aria-hidden','false');
    }
    function closeUpgradeModal() {
      const m = document.getElementById('upgradeModal');
      if (!m) return;
      m.classList.remove('open');
      m.setAttribute('aria-hidden','true');
    }

    function selectPlan(plan) {
    if (plan === "pro") {
      document.getElementById("planPro").classList.add("active");
    }
    }

    document.getElementById("continueToPayment").addEventListener("click", () => {
    document.getElementById("upgradeStep1").classList.add("hidden");
    document.getElementById("upgradeStep2").classList.remove("hidden");
    });

    document.getElementById("applyDiscountBtn").addEventListener("click", () => {
    const code = document.getElementById("discountCode").value.trim().toLowerCase();
    const msg = document.getElementById("discountMessage");
    const total = document.getElementById("totalAmount");

    if (code === "symposia10") {
      msg.textContent = "10% discount applied!";
      total.textContent = "€13.50";
    } else if (code === "symposia25") {
      msg.textContent = "25% discount applied!";
      total.textContent = "€11.25";
    } else {
      msg.textContent = "Invalid code.";
    }
    });
    // === Connect all triggers ===
    document.querySelector("#remainingDownloadsBtn")?.addEventListener("click", openUpgradeModal);
    document.querySelector(".menu-item[onclick='openUpgradePlan()']")?.addEventListener("click", openUpgradeModal);

    </script>
  </body>
</html>
